#!/usr/bin/env python

"""QA of Tractor modeling results.

NB: This diagnostic routine should be used for a relatively small
number of objects (~hundreds).


salloc -N 1 -C cpu -A m3592 -t 04:00:00 --qos interactive
SGA2025-shifter
source /global/homes/i/ioannis/code/SGA/bin/SGA2025/SGA2025-env

SGA2025-tractor-qa --datadir=/pscratch/sd/i/ioannis/SGA2025-v0.10 --last=10
SGA2025-tractor-qa --datadir=/pscratch/sd/i/ioannis/SGA2025-lvd --lvd
SGA2025-tractor-qa --datadir=/pscratch/sd/i/ioannis/SGA2025-lvd --lvd-ignore
SGA2025-tractor-qa --datadir=/pscratch/sd/i/ioannis/SGA2025-lvd --lvd-forcepsf


VI campaign:

## v0.22
SGA2025-tractor-qa --datadir=/pscratch/sd/i/ioannis/SGA2025-v0.22 --region=dr11-south --vi-sample=5




## v0.11
SGA2025-tractor-qa --datadir=/pscratch/sd/i/ioannis/SGA2025-v0.11 --final-sample --hide-tractor-ellipse --hide-initial-ellipse --region=dr11-south --vi-sample=1
SGA2025-tractor-qa --datadir=/pscratch/sd/i/ioannis/SGA2025-v0.11 --final-sample --hide-tractor-ellipse --hide-initial-ellipse --region=dr11-south --vi-sample=2
SGA2025-tractor-qa --datadir=/pscratch/sd/i/ioannis/SGA2025-v0.11 --final-sample --hide-tractor-ellipse --hide-initial-ellipse --region=dr11-south --vi-sample=3
SGA2025-tractor-qa --datadir=/pscratch/sd/i/ioannis/SGA2025-v0.11 --final-sample --region=dr11-south --vi-sample=4
SGA2025-tractor-qa --datadir=/pscratch/sd/i/ioannis/SGA2025-v0.11 --final-sample --region=dr11-south --vi-sample=5
SGA2025-tractor-qa --datadir=/pscratch/sd/i/ioannis/SGA2025-v0.11 --final-sample --region=dr11-south --vi-sample=6
SGA2025-tractor-qa --datadir=/pscratch/sd/i/ioannis/SGA2025-v0.11 --final-sample --region=dr11-south --vi-sample=7

SGA2025-tractor-qa --datadir=/pscratch/sd/i/ioannis/SGA2025-v0.11 --final-sample --hide-tractor-ellipse --hide-initial-ellipse --region=dr9-north --vi-sample=1
SGA2025-tractor-qa --datadir=/pscratch/sd/i/ioannis/SGA2025-v0.11 --final-sample --hide-tractor-ellipse --hide-initial-ellipse --region=dr9-north --vi-sample=2
SGA2025-tractor-qa --datadir=/pscratch/sd/i/ioannis/SGA2025-v0.11 --final-sample --hide-tractor-ellipse --hide-initial-ellipse --region=dr9-north --vi-sample=3
SGA2025-tractor-qa --datadir=/pscratch/sd/i/ioannis/SGA2025-v0.11 --final-sample --region=dr9-north --vi-sample=4
SGA2025-tractor-qa --datadir=/pscratch/sd/i/ioannis/SGA2025-v0.11 --final-sample --region=dr9-north --vi-sample=5
SGA2025-tractor-qa --datadir=/pscratch/sd/i/ioannis/SGA2025-v0.11 --final-sample --region=dr9-north --vi-sample=6
SGA2025-tractor-qa --datadir=/pscratch/sd/i/ioannis/SGA2025-v0.11 --final-sample --region=dr9-north --vi-sample=7

# some tests
SGA2025-tractor-qa --datadir=/pscratch/sd/i/ioannis/SGA2025-v0.11 --final-sample --region=dr9-north --vi-sample=999 --version=v0.11
SGA2025-tractor-qa --datadir=/pscratch/sd/i/ioannis/SGA2025-v0.11 --final-sample --region=dr11-south --vi-sample=999 --version=v0.11

SGA2025-tractor-qa --datadir=/pscratch/sd/i/ioannis/SGA2025-v0.11 --final-sample --region=dr9-north --vi-sample=900 --version=v0.11 # GCLPNE
SGA2025-tractor-qa --datadir=/pscratch/sd/i/ioannis/SGA2025-v0.11 --final-sample --region=dr9-north --vi-sample=901 --version=v0.11 # PSF / isolated
SGA2025-tractor-qa --datadir=/pscratch/sd/i/ioannis/SGA2025-v0.11 --final-sample --region=dr9-north --vi-sample=902 --version=v0.11 # PSF / in group


SGA2025-tractor-qa --datadir=/pscratch/sd/i/ioannis/SGA2025-testbricks-v0.21 --final-sample --region=dr11-south --vi-sample=1 --version=v0.21

SGA2025-tractor-qa --datadir=/pscratch/sd/i/ioannis/SGA2025-v0.22 --region=dr11-south --version=v0.22


"""

import pdb # for debugging

import os
from glob import glob
import numpy as np
from astropy.table import Table, vstack
import fitsio

import matplotlib.pyplot as plt
from matplotlib.backends.backend_pdf import PdfPages
import matplotlib.gridspec as gridspec
from matplotlib.image import imread

from PIL import Image
Image.MAX_IMAGE_PIXELS = None

from SGA.SGA import (sga_dir, sga_data_dir, get_galaxy_galaxydir,
                     read_sample, DIAMCOLUMN, REFIDCOLUMN, SAMPLE,
                     REFCAT, SGA_version)
from SGA.ellipse import ELLIPSEMODE
from SGA.io import get_raslice
from SGA.geometry import get_tractor_ellipse
from SGA.qa import overplot_ellipse
from SGA.logger import log


MAXDIAM = 3. # [arcmin]


def read_coadds(galaxy, galaxydir, refid, ra=None, dec=None, diam=None,
                cutout_galaxy=None, cutout_galaxydir=None, cutout=False):

    from astropy.wcs import WCS

    if cutout:
        from SGA.sky import simple_wcs
        from SGA.cutouts import get_pixscale_and_width

        pixscale, width = get_pixscale_and_width(
            np.atleast_1d(diam), maxdiam_arcmin=MAXDIAM)
        wcs = simple_wcs(ra, dec, width[0], pixscale[0])

        # strip the galaxy subdirectory
        imagefile = os.path.join(os.path.dirname(cutout_galaxydir), f'{cutout_galaxy}.jpeg')
        if not os.path.isfile(imagefile):
            msg = f'Cutout for {cutout_galaxydir} not found'
            log.warning(msg)
            raise ValueError(msg)
        image = imread(imagefile)
        assert(image.shape[0] == width[0])

        # if this object had GROUP_PRIMARY=False then there's also a
        # Tractor catalog
        if os.path.isdir(galaxydir):
        #if cutout_galaxy == 'SGA2025_J0150.925+068.693':
            raise ValueError('WRITE ME!!')

        return Table(), Table(), image, wcs


    imagefile = os.path.join(galaxydir, f'{galaxy}-image.jpg')
    #imagefile = os.path.join(galaxydir, f'{galaxy}-model.jpg')
    #imagefile = os.path.join(galaxydir, f'{galaxy}-resid.jpg')
    tractorfile = os.path.join(galaxydir, f'{galaxy}-tractor.fits')

    # this should never happen since we check for images earlier
    if not os.path.isfile(imagefile) and not os.path.isfile(tractorfile):
        log.warning(f'Missing pipeline outputs for {galaxydir}/{galaxy}')
        return Table(), Table(), None, None

    #if not os.path.isfile(tractorfile):
    #    log.warning(f'Missing {tractorfile}')
    #    return Table(), Table(), None, None

    # OK to have an image but no Tractor catalog (e.g., LVD / resolved)
    if os.path.isfile(tractorfile):
        cols = np.array(['bx', 'by', 'ra', 'dec', 'type', 'sersic', 'shape_r',
                         'shape_e1', 'shape_e2', 'ref_cat', 'ref_id', 'flux_g',
                         'flux_r', 'flux_i', 'flux_z'])
        #allcols = np.array(fitsio.FITS(tractorfile)[1].get_colnames())
        #cols = cols[np.isin(cols, allcols)]
        #print(galaxydir)
        tractor = Table(fitsio.read(tractorfile, columns=cols))

        I = (np.logical_or(tractor['ref_cat'] == 'LG', tractor['ref_cat'] == REFCAT) * \
             (tractor['ref_id'] == refid))
        if np.sum(I) == 0:
            sga = Table()
        else:
            sga = tractor[I]
            #tractor = tractor[~I]
    else:
        log.warning(f'Missing tractor catalog {tractorfile}')
        sga = Table()
        tractor = Table()

    if not os.path.isfile(imagefile):
        msg = f'Images should never be missing at this point! {galaxydir}/{galaxy}'
        log.critical(msg)
        raise ValueError(msg)

    image = imread(imagefile)
    for band in ['g', 'r', 'i', 'z']:
        fitsfile = os.path.join(galaxydir, f'{galaxy}-image-{band}.fits.fz')
        if os.path.isfile(fitsfile):
            hdr = fitsio.read_header(fitsfile, ext=1)
            wcs = WCS(hdr, naxis=2)
            break

    return sga, tractor, image, wcs


def annotated(sample, fullsample, pdffile, ncol=4, nrow=2, inches_per_panel=4.,
              datadir=None, cutoutdir=None, region='dr11-south', no_groups=False,
              show_tractor_ellipse=True, show_initial_ellipse=True,
              final_sample=False, verbose=False):

    from astropy.wcs.utils import proj_plane_pixel_scales as get_pixscale
    import matplotlib as mpl

    # reduces file size
    mpl.rcParams["pdf.compression"] = 9
    mpl.rcParams['path.simplify'] = True
    mpl.rcParams["path.simplify_threshold"] = 1.0
    mpl.rcParams["pdf.fonttype"] = 42
    mpl.rcParams["ps.fonttype"] = 42
    mpl.rcParams["pdf.use14corefonts"] = True

    if no_groups:
        showsample = sample
    else:
        # each group member gets its own panel
        showsample = fullsample

    galaxy, galaxydir = get_galaxy_galaxydir(showsample, region=region,
                                             group=not no_groups,
                                             datadir=datadir)
    I = showsample['CUTOUT'].value
    if np.any(I):
        cutout_galaxy = np.copy(galaxy)
        cutout_galaxydir = np.copy(galaxydir)
        cgalaxy, cgalaxydir = get_galaxy_galaxydir(showsample[I], region=region,
                                                   group=not no_groups,
                                                   datadir=cutoutdir)
        cutout_galaxy[I] = cgalaxy
        cutout_galaxydir[I] = cgalaxydir
    else:
        cutout_galaxy = [None] * len(showsample)
        cutout_galaxydir = [None] * len(showsample)

    galaxy = np.atleast_1d(galaxy)
    galaxydir = np.atleast_1d(galaxydir)

    nobj = len(showsample)
    allindx = np.arange(nobj)

    nperpage = ncol * nrow
    npage = int(np.ceil(nobj / nperpage))

    pdf = PdfPages(pdffile)
    for ipage in range(npage):
        if verbose:
            log.info(f'Building page {ipage+1:,d}/{npage:,d}')
        else:
            if (ipage+1) % 64 == 0:
                log.info(f'Building page {ipage+1:,d}/{npage:,d}')
        indx = allindx[ipage*nperpage:(ipage+1)*nperpage]

        fig, ax = plt.subplots(nrow, ncol,
                               figsize=(inches_per_panel*ncol,
                                        inches_per_panel*nrow),
                               gridspec_kw={'wspace': 0.02, 'hspace': 0.02},
                               constrained_layout=True)
        ax = ax.ravel()

        for iax, xx in enumerate(ax):
            if iax < len(indx):
                obj = showsample[indx[iax]]
                #print(obj['OBJNAME'])

                if final_sample:
                    #diam, ba, pa = obj['D26']*60., obj['BA'], obj['PA']
                    objra, objdec, diam, ba, pa = obj['RA'], obj['DEC'], obj['D26']*60., obj['BA'], obj['PA']
                    geo = f'D(26)={diam:.1f}" b/a={ba:.2f} PA={pa:.1f}'

                    #diam0, ba0, pa0 = obj['DIAM_INIT']*60., obj['BA_INIT'], obj['PA_INIT']
                    objra0, objdec0, diam0, ba0, pa0 = obj['RA_INIT'], obj['DEC_INIT'], obj['DIAM_INIT']*60., obj['BA_INIT'], obj['PA_INIT']
                    geo0 = f'D(25)={diam0:.1f}" b/a={ba0:.2f} PA={pa0:.1f}'
                else:
                    objra0, objdec0, diam0, ba0, pa0 = obj['RA'], obj['DEC'], obj['DIAM']*60., obj['BA'], obj['PA']
                    geo0 = f'D(25)={diam0:.1f}" b/a={ba0:.2f} PA={pa0:.1f}'


                if final_sample:
                    txt = [obj["OBJNAME"], obj["GROUP_NAME"],
                           r'$(\alpha,\delta)$='+f'({objra:.7f},{objdec:.6f})']
                    if show_initial_ellipse:
                        txt += [geo0]
                    txt += [geo]
                else:
                    txt = [obj["OBJNAME"], #obj["SGANAME"],
                           r'$(\alpha,\delta)$='+f'({objra0:.7f},{objdec0:.6f})',
                           geo0]
                txt_ul = '\n'.join(txt)
                xx.text(0.03, 0.97, txt_ul, transform=xx.transAxes, ha='left',
                        va='top', color='white', linespacing=1.5, fontsize=9,
                        bbox=dict(boxstyle='round', facecolor='k', alpha=0.5))

                if obj['CUTOUT'] or no_groups:
                    groupdiam = obj['DIAM'] * 60., # [arcsec]
                    if final_sample:
                        groupra = obj['RA']
                        groupdec = obj['DEC']
                    else:
                        groupra = obj['RA_INIT']
                        groupdec = obj['DEC_INIT']
                else:
                    groupdiam = obj['GROUP_DIAMETER'] * 60., # [arcsec]
                    groupra = obj['GROUP_RA']
                    groupdec = obj['GROUP_DEC']

                sga, tractor, image, wcs = read_coadds(
                    galaxy[indx[iax]], galaxydir[indx[iax]],
                    refid=obj[REFIDCOLUMN], ra=groupra, dec=groupdec,
                    diam=groupdiam, cutout_galaxy=cutout_galaxy[indx[iax]],
                    cutout_galaxydir=cutout_galaxydir[indx[iax]],
                    cutout=obj['CUTOUT'])

                if image is None:
                    txt_ll = 'No Tractor catalog'
                    txt_ur = None
                else:
                    height, width, _ = image.shape
                    pixscale = get_pixscale(wcs)[0] * 3600. # [arcsec/pixel]

                    xx.set_xlim(0, width)
                    xx.set_ylim(0, height)

                    xx.imshow(image, origin='lower', interpolation='none')
                    xx.invert_yaxis() # JPEG is flipped relative to FITS
                    for spine in ['bottom', 'top', 'right', 'left']:
                        xx.spines[spine].set_color('white')

                    if len(tractor) > 0:
                        I = (tractor['ref_cat'] == 'L4')
                        #I = ((tractor['type'] != 'PSF') * (tractor['type'] != 'DUP') *
                        #     (tractor['shape_r'] > 0.5))
                        #I = tractor['shape_r'] >= 0.
                        #I = tractor['shape_r'] > 1.
                        if np.sum(I) > 0:# and False:
                            if np.sum(I) > 50:
                                alpha = 0.5
                                s = 10
                            else:
                                alpha = 1.0
                                s = 25
                            xx.scatter(tractor['bx'][I], height-tractor['by'][I],
                                       marker='x', s=s, color='red', alpha=alpha)

                        J = np.logical_or(tractor['type'] == 'PSF', tractor['type'] == 'DUP')
                        #print(galaxy[indx[iax]], np.sum(J))
                        if np.sum(J) > 0 and False:
                            if np.sum(J) > 50:
                                s = 1
                                alpha = 0.5
                            else:
                                s = 10
                                alpha = 0.9
                            xx.scatter(tractor['bx'][J], height-tractor['by'][J],
                                       marker='o', s=s, color='white', alpha=alpha)

                    if len(sga) > 0:
                        from SGA.geometry import get_tractor_ellipse
                        _, ba_tractor, pa_tractor = get_tractor_ellipse(sga['shape_r'][0], sga['shape_e1'][0], sga['shape_e2'][0])
                        if final_sample:
                            if verbose:
                                print(f"{obj['OBJNAME']:28} {diam:05.0f} arcsec   {objra:.7f} {objdec:.7f} " + \
                                      f"{sga['ra'][0]:.7f} {sga['dec'][0]:.7f} {ba_tractor:.3f} {pa_tractor:.1f}")
                        else:
                            if verbose:
                                print(f"{obj['OBJNAME']:28} {diam0:05.0f} arcsec   {objra0:.7f} {objdec0:.7f} " + \
                                      f"{sga['ra'][0]:.7f} {sga['dec'][0]:.7f} {ba_tractor:.3f} {pa_tractor:.1f}")
                    else:
                        if final_sample:
                            if verbose:
                                print(f"{obj['OBJNAME']:28} {diam:05.0f} arcsec   {objra:.7f} {objdec:.7f}")
                        else:
                            if verbose:
                                print(f"{obj['OBJNAME']:28} {diam0:05.0f} arcsec   {objra0:.7f} {objdec0:.7f}")

                    # draw the initial and final ellipse geometry...
                    if final_sample:
                        (xpix, ypix) = wcs.wcs_world2pix(objra, objdec, 0)
                        (xpix0, ypix0) = wcs.wcs_world2pix(objra0, objdec0, 0)
                        if show_initial_ellipse:
                            overplot_ellipse(diam0, ba0, pa0, xpix0, ypix0,
                                             height_pixels=width, pixscale=pixscale,
                                             ax=xx, color='white', linewidth=0.3, linestyle='-',
                                             draw_majorminor_axes=False, jpeg=True)
                            #xx.scatter(xpix0, height-ypix0, marker='x',
                            #           facecolor='none', s=40, color='white')
                        overplot_ellipse(diam, ba, pa, xpix, ypix,
                                         height_pixels=width, pixscale=pixscale,
                                         ax=xx, color='cyan', linewidth=2, linestyle='-',
                                         draw_majorminor_axes=True, jpeg=True)
                        xx.scatter(xpix, height-ypix, marker='s',
                                   facecolor='none', s=40, color='cyan')

                    else:
                        if show_initial_ellipse:
                            (xpix0, ypix0) = wcs.wcs_world2pix(objra0, objdec0, 0)
                            overplot_ellipse(diam0, ba0, pa0, xpix0, ypix0,
                                             height_pixels=width, pixscale=pixscale,
                                             ax=xx, color='white', linestyle='-',
                                             draw_majorminor_axes=True, jpeg=True)


                    if len(sga) > 0:
                        typ, nn = sga['type'][0], sga['sersic'][0]
                        ra, dec = sga['ra'][0], sga['dec'][0]
                        r50 = sga['shape_r'][0]
                        e1, e2 = sga['shape_e1'][0], sga['shape_e2'][0]
                        diam, ba, pa = get_tractor_ellipse(r50, e1, e2)

                        mag = []
                        for band in ['g', 'r', 'i', 'z']:
                            if f'flux_{band}' in sga.colnames:
                                flux = sga[f'flux_{band}'][0]
                                if flux > 0.:
                                    mag.append(f'{band}={22.5-2.5*np.log10(flux):.2f}')
                        mag = ' '.join(mag)

                        if typ == 'PSF':
                            pass
                        elif typ == 'REX':
                            geo = f'r(50)={r50:.1f}"'
                        elif typ == 'SER':
                            typ = f'{typ} (n={nn:.1f})'
                            geo = f'r(50)={r50:.1f}" b/a={ba:.2f} PA={pa:.1f}'
                        else:
                            geo = f'r(50)={r50:.1f}" b/a={ba:.2f} PA={pa:.1f}'

                        txt_ur = f'{typ}'
                        if typ == 'PSF':
                            txt_ll = '\n'.join([r'$(\alpha,\delta)$='+f'({ra:.7f},{dec:.6f})', mag])
                        else:
                            txt_ll = '\n'.join([geo, r'$(\alpha,\delta)$='+f'({ra:.7f},{dec:.6f})', mag])
                    else:
                        if len(tractor) > 0:
                            txt_ur = None
                            txt_ll = 'SGA source dropped'
                        else:
                            txt_ur = None
                            txt_ll = 'Missing Tractor catalog'

                # label the other objects in the group
                if no_groups:
                    for otherobj in fullsample:
                        if otherobj[REFIDCOLUMN] == obj[REFIDCOLUMN]:
                            continue
                        (xpix, ypix) = wcs.wcs_world2pix(otherobj['RA'], otherobj['DEC'], 0)
                        diam0, ba0, pa0 = otherobj['DIAM']*60., otherobj['BA'], otherobj['PA']
                        overplot_ellipse(diam0, ba0, pa0, xpix, ypix,
                                         height_pixels=width, pixscale=pixscale,
                                         ax=xx, color='white', linestyle='-',
                                         draw_majorminor_axes=False, jpeg=True)

                xx.margins(0)
                xx.set_xticks([])
                xx.set_yticks([])

                if txt_ll and show_tractor_ellipse:
                    xx.text(0.03, 0.03, txt_ll, transform=xx.transAxes,
                            ha='left', va='bottom', color='white',
                            linespacing=1.5, fontsize=9,
                            bbox=dict(boxstyle='round', facecolor='k', alpha=0.5))

                if txt_ur and show_tractor_ellipse:
                    xx.text(0.97, 0.97, txt_ur, transform=xx.transAxes,
                            ha='right', va='top', color='white',
                            linespacing=1.5, fontsize=9,
                            bbox=dict(boxstyle='round', facecolor='k', alpha=0.5))

                if len(sga) > 0 and show_tractor_ellipse:
                    # ...and the Tractor model
                    (xpix, ypix) = wcs.wcs_world2pix(sga['ra'], sga['dec'], 0)
                    overplot_ellipse(2.*r50, ba, pa, xpix, ypix,
                                     height_pixels=height, pixscale=pixscale,
                                     ax=xx, color='yellow', linewidth=1, linestyle='--',
                                     draw_majorminor_axes=True, jpeg=True)
                    xx.scatter(sga['bx'], height-sga['by'], marker='s',
                               facecolor='none', s=40, color='yellow')

                xx.text(0.97, 0.03, str(indx[iax]+1), transform=xx.transAxes,
                        ha='right', va='bottom', color='white',
                        linespacing=1.5, fontsize=9,
                        bbox=dict(boxstyle='round', facecolor='k', alpha=0.5))

            else:
                xx.axis('off')
        pdf.savefig(fig, bbox_inches='tight')
        plt.close()
        if verbose:
            print()

    pdf.close()
    log.info(f'Wrote {pdffile}')

    plt.rcParams['path.simplify'] = False # restore


def qa_tractor(region='dr11-south', first=None, last=None, galaxylist=None, mp=1,
               nperpdf=4096, ncol=4, nrow=2, datadir=None, lvd_resolved=False,
               lvd_fixgeo=False, lvd_forcepsf=False, lvd=False, version=None,
               vi_sample=None, final_sample=False, no_groups=False, show_tractor_ellipse=True,
               show_initial_ellipse=True, verbose=False, mindiam=0., maxdiam=1e3):
    """
    nperpdf - maximum number of galaxies per pdf
    ncol - number of columns on each pdf page
    nrow - number of rows on each pdf page

    """
    from SGA.SGA import SAMPLE
    from SGA.ellipse import ELLIPSEBIT, ELLIPSEMODE
    from SGA.groups import remove_small_groups
    from SGA.coadds import REGIONBITS


    if datadir is None:
        datadir = sga_data_dir()
    cutoutdir = os.path.join(datadir, 'cutouts')

    sample, fullsample = read_sample(region=region, first=first,
                                     last=last, galaxylist=galaxylist,
                                     no_groups=no_groups,
                                     final_sample=final_sample,
                                     mindiam=mindiam, maxdiam=maxdiam)

    if version is None:
        version = SGA_version()

    if vi_sample:
        subdir = f'vi-{version}'
        qadir = f'/global/cfs/cdirs/cosmo/www/temp/SGA2025/{subdir}/pdf'
        txtdir = f'/global/cfs/cdirs/cosmo/www/temp/SGA2025/{subdir}/txt'
        viewdir = f'/global/cfs/cdirs/cosmo/www/temp/SGA2025/{subdir}/viewer'
    else:
        qadir = os.path.join(sga_dir(), 'parent', 'qa')
        txtdir = os.path.join(sga_dir(), 'parent', 'txt')
        viewdir = os.path.join(sga_dir(), 'parent', 'viewer')

    if final_sample:
        diamcolumn = 'D26'
        diamerrcolumn = 'D26_ERR'
    else:
        diamcolumn = 'DIAM'
        diamerrcolumn = None

    if vi_sample == 1:
        # all groups containing one or more LVD dwarf
        sort_by_groupname = False
        is_LVD  = (fullsample['SAMPLE'] & SAMPLE['LVD']) != 0
        LVD_group_names = np.unique(fullsample['GROUP_NAME'][is_LVD])
        I = np.isin(fullsample['GROUP_NAME'], LVD_group_names)
        fullsample = fullsample[I]
        # Need to remove SMC, LMC
        log.warning('Removing LMC, SMC (coadds are too large).')
        fullsample = fullsample[~np.isin(fullsample['OBJNAME'], ['LMC', 'SMC'])]
        sample = fullsample[fullsample['GROUP_PRIMARY']]
    else:
        sort_by_groupname = False
        if no_groups:
            pdfsuffix = '-no-groups'
        else:
            pdfsuffix = ''
        pdfbase = f'qa-tractor-{region}-sample{pdfsuffix}'

        pdb.set_trace()
        #########################
        sort_by_groupname = False

        #I_overlap = ((fullsample['SAMPLE'] & SAMPLE['OVERLAP']) != 0) & (fullsample['GROUP_DIAMETER'] > 1.)
        #I_overlap = ((fullsample['SAMPLE'] & SAMPLE['OVERLAP']) != 0) & (fullsample['GROUP_DIAMETER'] > 1.) & (fullsample['GROUP_DIAMETER'] <= 1.5)
        I_overlap = ((fullsample['SAMPLE'] & SAMPLE['OVERLAP']) != 0) & (fullsample['GROUP_DIAMETER'] > 0.75) & (fullsample['GROUP_DIAMETER'] <= 1.)
        I_sdss = np.char.startswith(fullsample['OBJNAME'].astype(str), "SDSS")

        # Find groups satisfying each condition
        groups_with_overlap = set(fullsample['GROUP_NAME'][I_overlap])
        groups_with_sdss = set(fullsample['GROUP_NAME'][I_sdss])

        # Intersection = groups meeting BOTH conditions
        groups_target = groups_with_overlap & groups_with_sdss

        # Extract all rows from those groups
        rows = np.isin(fullsample['GROUP_NAME'], list(groups_target))
        I = rows & I_sdss

        #########################
        fullsample = fullsample[I]
        sample = fullsample

        # We still want to see and label nearby companions in
        # 'fullsample', i.e., without any diameter cuts.
        if no_groups:
            diamcolumn = 'DIAM'
            _, fullsample = read_sample(region=region)
        else:
            diamcolumn = DIAMCOLUMN
        fullsample = fullsample[np.isin(fullsample['GROUP_ID'], sample['GROUP_ID'])]


    # make the output directories
    if not os.path.isdir(qadir):
        os.makedirs(qadir, exist_ok=True)
    if txtdir and not os.path.isdir(txtdir):
        os.makedirs(txtdir, exist_ok=True)
    if viewdir and not os.path.isdir(viewdir):
        os.makedirs(viewdir, exist_ok=True)

    galaxy, galaxydir = get_galaxy_galaxydir(sample, region=region,
                                             group=not no_groups,
                                             datadir=datadir)
    #I = np.array([os.path.isdir(gdir) for gdir in np.atleast_1d(galaxydir)])
    I = np.array([os.path.isfile(os.path.join(gdir, f'{gal}-image.jpg'))
                  for gdir, gal in zip(np.atleast_1d(galaxydir), np.atleast_1d(galaxy))])
    log.info(f'Found {np.sum(I):,d}/{len(sample):,d} ' + \
             '(GROUP_PRIMARY) objects with pipeline results.')

    # check for cutouts and, if missing, generate them
    sample['CUTOUT'] = np.zeros(len(sample), bool)
    fullsample['CUTOUT'] = np.zeros(len(fullsample), bool)
    if np.sum(~I) > 0:
        if np.sum(~I) > 500:
            log.warning('Are you sure you want to generate cutouts for more than 500 objects!!')
            raise ValueError()

        sample['CUTOUT'][~I] = True
        fullsample['CUTOUT'][np.isin(fullsample['GROUP_ID'], sample['GROUP_ID'][~I])] = True

        galaxy, galaxydir = get_galaxy_galaxydir(sample[~I], region=region,
                                                 group=not no_groups,
                                                 datadir=cutoutdir)
        #M = [not os.path.isdir(gdir) for gdir in np.atleast_1d(galaxydir)]
        M = [not os.path.isfile(os.path.join(gdir, f'{gal}-image.jpg'))
             for gdir, gal in zip(np.atleast_1d(galaxydir), np.atleast_1d(galaxy))]

        log.info(f'Generating cutouts for {np.sum(M):,d}/{np.sum(~I):,d} ' + \
                 'objects with missing pipeline results.')

        if np.sum(M) > 0:
            from SGA.cutouts import do_cutouts

            layer = f'ls-{region}'
            if region == 'dr11-south':
                log.warning(f"Overriding layer={layer}-->ls-dr11-early-v2")
                layer = 'ls-dr11-early-v2'

            do_cutouts(sample[~I][M], layer=layer, group=not no_groups,
                       fits_cutouts=False, maxdiam_arcmin=MAXDIAM, mp=mp,
                       cutoutdir=os.path.join(cutoutdir, region))


    # sort by diameter (?)
    if sort_by_groupname:
        fullsample = fullsample[np.lexsort((fullsample[diamcolumn], fullsample['GROUP_NAME']))]
        sample = sample[np.argsort(sample['GROUP_NAME'])]
    else:
        sample = sample[np.argsort(sample[diamcolumn])]
        fullsample = fullsample[np.argsort(fullsample[diamcolumn])]

    # figure out how many PDF documents / subsamples based on nperpdf
    ngal = len(fullsample)
    npdf = int(np.ceil(ngal / nperpdf))
    log.info(f'Generating {npdf} PDF documents for {ngal:,d} galaxies with {nperpdf} objects per PDF.')

    for ipdf in range(npdf):
    #for ipdf in [70]:#range(npdf):
        # special case the VI work: custom name and write out a text file
        istart = ipdf*nperpdf
        iend = min((ipdf+1)*nperpdf, ngal)
        indx = np.arange(istart, iend)

        thisfullsample = fullsample[indx]
        thissample = sample[np.isin(sample['GROUP_ID'], thisfullsample['GROUP_ID'])]

        # re-sort by diameter (?)
        if sort_by_groupname:
            thisfullsample = thisfullsample[np.lexsort((thisfullsample[diamcolumn], thisfullsample['GROUP_NAME']))]
            thissample = thissample[np.argsort(thissample['GROUP_NAME'])]
        else:
            thissample = thissample[np.argsort(thissample[diamcolumn])]
            thisfullsample = thisfullsample[np.argsort(thisfullsample[diamcolumn])]

        if vi_sample:
            pdffile = os.path.join(qadir, f'qa-sample{vi_sample:03}-subset{ipdf+1:03}-{region}.pdf')
            txtfile = os.path.join(txtdir, f'cat-sample{vi_sample:03}-subset{ipdf+1:03}-{region}.txt')

            if viewdir:
                viewfile = os.path.join(viewdir, f'viewer-sample{vi_sample:03}-subset{ipdf+1:03}-{region}.fits')
                view = thisfullsample['OBJNAME', 'RA', 'DEC', 'D26', 'BA', 'PA']
                view.rename_columns(['OBJNAME', 'RA', 'DEC', 'D26', 'BA', 'PA'], ['name', 'ra', 'dec', 'radius', 'abRatio', 'posAngle'])
                view['radius'] *= 60./2.
                view.write(viewfile, overwrite=True)

            with open(txtfile, 'w') as F:
                for obj in thisfullsample['OBJNAME'].value:
                    F.write(f'{obj}\n')
            log.info(f'Wrote {txtfile}')
        else:
            pdffile = os.path.join(qadir, f'{pdfbase}-{ipdf+1:03}.pdf')
            txtfile = os.path.join(txtdir, f'cat-{pdfbase}-{ipdf+1:03}.txt')

            if viewdir:
                viewfile = os.path.join(viewdir, f'viewer-{pdfbase}-{ipdf+1:03}.fits')
                view = thisfullsample['OBJNAME', 'RA', 'DEC', 'DIAM', 'BA', 'PA']
                view.rename_columns(['OBJNAME', 'RA', 'DEC', 'DIAM', 'BA', 'PA'], ['name', 'ra', 'dec', 'radius', 'abRatio', 'posAngle'])
                view['radius'] *= 60./2.
                view.write(viewfile, overwrite=True)

            with open(txtfile, 'w') as F:
                for obj in thisfullsample['OBJNAME'].value:
                    F.write(f'{obj}\n')
            log.info(f'Wrote {txtfile}')


        if os.path.isfile(pdffile):
            log.info(f'Skipping existing file {pdffile}')
            continue

        annotated(thissample, thisfullsample, pdffile, region=region,
                  datadir=datadir, cutoutdir=cutoutdir,
                  ncol=ncol, nrow=nrow, verbose=verbose,
                  show_tractor_ellipse=show_tractor_ellipse,
                  show_initial_ellipse=show_initial_ellipse,
                  final_sample=final_sample, no_groups=no_groups)


if __name__ == '__main__':

    import argparse

    parser = argparse.ArgumentParser()
    parser.add_argument('--first', type=int, help='Index of first object to process.')
    parser.add_argument('--last', type=int, help='Index of last object to process.')
    parser.add_argument('--galaxylist', type=str, default=None, help='Comma-separated list of galaxy names to process.')

    parser.add_argument('--version', type=str, default=None, help='SGA version.')

    parser.add_argument('--mp', default=1, type=int, help='number of multiprocessing processes per MPI rank.')
    parser.add_argument('--mindiam', default=0., type=float, help='minimum diameter')
    parser.add_argument('--maxdiam', default=1e3, type=float, help='minimum diameter')
    parser.add_argument('--ncol', default=4, type=int, help='number of columns on each PDF page')
    parser.add_argument('--nrow', default=2, type=int, help='number of rows on each PDF page')
    parser.add_argument('--nperpdf', default=4096, type=int, help='number of panels per PDF document')

    parser.add_argument('--vi-sample', default=None, type=int, help='VI sample to generate.')
    parser.add_argument('--hide-tractor-ellipse', dest='show_tractor_ellipse', action='store_false',
                        help='Hide the Tractor ellipse geometry')
    parser.add_argument('--hide-initial-ellipse', dest='show_initial_ellipse', action='store_false',
                        help='Hide the initial ellipse geometry')

    parser.add_argument('--lvd-resolved', action='store_true', help='Generate QA for the LVD/resolved sample.')
    parser.add_argument('--lvd-fixgeo', action='store_true', help='Generate QA for the LVD/fixgeo sample.')
    parser.add_argument('--lvd-forcepsf', action='store_true', help='Generate QA for the LVD/force-PSF sample.')
    parser.add_argument('--lvd', action='store_true', help='Generate QA for the remaining LVD sample.')
    parser.add_argument('--no-groups', action='store_true', help='Do not show group cutouts.')
    parser.add_argument('--final-sample', action='store_true', help='Read the final SGA-2025 sample.')
    parser.add_argument('--datadir', default=None, type=str, help='Override $SGA_DATA_DIR environment variable')
    parser.add_argument('--region', default='dr11-south', choices=['dr9-north', 'dr11-south'], type=str, help='Region analyze')
    parser.add_argument('--verbose', action='store_true', help='Be verbose.')

    args = parser.parse_args()

    qa_tractor(datadir=args.datadir, region=args.region, first=args.first,
               last=args.last, galaxylist=args.galaxylist, mp=args.mp,
               lvd_resolved=args.lvd_resolved, lvd_fixgeo=args.lvd_fixgeo,
               lvd_forcepsf=args.lvd_forcepsf, lvd=args.lvd,
               version=args.version, vi_sample=args.vi_sample, ncol=args.ncol, nrow=args.nrow,
               nperpdf=args.nperpdf, show_tractor_ellipse=args.show_tractor_ellipse,
               show_initial_ellipse=args.show_initial_ellipse,
               final_sample=args.final_sample, no_groups=args.no_groups,
               mindiam=args.mindiam, maxdiam=args.maxdiam, verbose=args.verbose)


def junk():
    LVD      = SAMPLE['LVD']
    MCLOUDS  = SAMPLE['MCLOUDS']
    GCLPNE   = SAMPLE['GCLPNE']
    NEARSTAR = SAMPLE['NEARSTAR']
    INSTAR   = SAMPLE['INSTAR']

    gm1 = (fullsample['GROUP_MULT'] == 1)
    gm2 = (fullsample['GROUP_MULT'] == 2)
    gm3 = (fullsample['GROUP_MULT'] > 2)

    not_LVD = (fullsample['SAMPLE'] & LVD) == 0
    is_LVD  = (fullsample['SAMPLE'] & LVD) != 0

    ellipse_ok  = (fullsample['ELLIPSEBIT'] == 0)
    ellipse_bad = (fullsample['ELLIPSEBIT'] != 0)

    sample_flags = (fullsample['SAMPLE'] & (MCLOUDS | GCLPNE | NEARSTAR | INSTAR)) != 0

    diamcolumn = 'D26'
    diamerrcolumn = 'D26_ERR'
    sort_by_groupname = False

    # samples 001–007 are mutually exclusive.
    # Their union includes:
    #   * all non-LVD objects with GROUP_MULT == 1 and D26 ≥ 0.5;
    #   * all LVD groups’ primaries (except explicitly dropped LMC/SMC);
    #   * all non-LVD groups’ primaries with GROUP_MULT ≥ 2 and at least one member having D26 ≥ 0.5.

    if vi_sample == 1:
        # sample 001 - GM=1, in size range, no bits set at all, ellipse clean, not LVD
        print('HACK!')
        diam_cut = (fullsample[diamcolumn] >= 0.5) & (fullsample[diamcolumn] < 5.)
        I = gm1 & diam_cut & not_LVD & (fullsample['SAMPLE'] == 0)
        #I = gm1 & diam_cut & not_LVD & ellipse_ok & (fullsample['SAMPLE'] == 0)
        fullsample = fullsample[I]
        sample = fullsample
    elif vi_sample == 2:
        # sample 002 - GM=1, in size range, ellipse clean, at least one of {MCLOUDS,GCLPNE,NEARSTAR,INSTAR} set, and not LVD
        #diam_cut = (fullsample[diamcolumn] >= 0.5) & (fullsample[diamcolumn] < 5.)
        #I = gm1 & diam_cut & not_LVD & ellipse_ok & sample_flags
        print('HACK!')
        sort_by_groupname = True
        #_, rem = remove_small_groups(fullsample, minmult=2, maxmult=None, mindiam=0.5, diamcolumn=diamcolumn)#, diamerrcolumn=diamerrcolumn)
        #I = (gm1 & (fullsample[diamcolumn] < 0.5)) | np.isin(fullsample['GROUP_NAME'], rem['GROUP_NAME'])
        _, rem1 = remove_small_groups(fullsample, minmult=2, maxmult=None, mindiam=0.5, diamcolumn=diamcolumn)#, diamerrcolumn=diamerrcolumn)
        I1 = (gm1 & (fullsample[diamcolumn] < 0.5)) | np.isin(fullsample['GROUP_NAME'], rem1['GROUP_NAME'])
        _, rem2 = remove_small_groups(fullsample, minmult=2, maxmult=None, mindiam=0.5, diamcolumn=diamcolumn, diamerrcolumn=diamerrcolumn)
        I2 = (gm1 & ((fullsample[diamcolumn]+fullsample[diamerrcolumn]) < 0.5)) | np.isin(fullsample['GROUP_NAME'], rem2['GROUP_NAME'])
        I = ( (np.isin(fullsample['GROUP_NAME'], rem1['GROUP_NAME']) & ~np.isin(fullsample['GROUP_NAME'], rem2['GROUP_NAME'])) |
              (gm1 & ((fullsample[diamcolumn]+fullsample[diamerrcolumn]) < 0.5)) & ~(gm1 & (fullsample[diamcolumn] < 0.5)) )
        fullsample = fullsample[I]
        sample = fullsample
    elif vi_sample == 3:
        # sample 003 - GM=1, in size range, not LVD, any ellipse problem
        diam_cut = (fullsample[diamcolumn] >= 0.5) & (fullsample[diamcolumn] < 5.)
        I = gm1 & diam_cut & not_LVD & ellipse_bad
        fullsample = fullsample[I]
        sample = fullsample
    elif vi_sample == 4:
        # sample 004 - GM=1, D(26)>5, not LVD, any ellipse problem
        diam_cut = (fullsample[diamcolumn] >= 5.)
        I = gm1 & diam_cut & not_LVD
        fullsample = fullsample[I]
        sample = fullsample
    elif vi_sample == 5:
        # sample 005 - all groups containing one or more LVD dwarfs
        sort_by_groupname = True
        LVD_group_names = np.unique(fullsample['GROUP_NAME'][is_LVD])
        I = np.isin(fullsample['GROUP_NAME'], LVD_group_names)
        pdb.set_trace()
        fullsample = fullsample[I]
        # Need to remove SMC, LMC
        log.warning('Removing LMC, SMC (coadds are too large).')
        fullsample = fullsample[~np.isin(fullsample['OBJNAME'], ['LMC', 'SMC'])]
        sample = fullsample[fullsample['GROUP_PRIMARY']]
    elif vi_sample == 6 or vi_sample == 7:
        sort_by_groupname = True
        LVD_group_names = np.unique(fullsample['GROUP_NAME'][is_LVD])
        fullsample_67, _ = remove_small_groups(fullsample, minmult=2, maxmult=None, mindiam=0.5,
                                               diamcolumn=diamcolumn, exclude_group_names=LVD_group_names)

        # split on ELLIPSEBIT
        gnames = fullsample_67['GROUP_NAME']
        ellipse_bad = fullsample_67['ELLIPSEBIT'] != 0
        order = np.argsort(gnames)
        gnames_sorted = gnames[order]
        bad_sorted = ellipse_bad[order]

        # Unique group IDs and start indices
        uniq_gnames, idx_start = np.unique(gnames_sorted, return_index=True)

        # For each group: does it have ANY bad member? Convert
        # bool→int so we can use reduceat with max.
        any_bad = np.maximum.reduceat(bad_sorted.astype(int), idx_start).astype(bool)

        good_group_names = uniq_gnames[~any_bad]  # all members ellipse_ok
        bad_group_names  = uniq_gnames[any_bad]   # at least one member ellipse_bad

        if vi_sample == 6:
            # sample 006 - groups with 2 or more members, all ellipse_ok & ~is_LVD
            fullsample = fullsample_67[np.isin(fullsample_67['GROUP_NAME'], good_group_names)]
        elif vi_sample == 7:
            # sample 007 - groups with 2 or more members, any ellipse_bad & ~is_LVD
            fullsample = fullsample_67[np.isin(fullsample_67['GROUP_NAME'], bad_group_names)]

        sample = fullsample[fullsample['GROUP_PRIMARY']]
    elif (vi_sample >= 900) & (vi_sample < 950):
        sort_by_groupname = False
        if vi_sample == 900:
            I = ((fullsample['SAMPLE'] & SAMPLE['GCLPNE'] != 0) * (fullsample['D26'] > 0.5))
        elif vi_sample == 901 or vi_sample == 902:
            fulltractor = Table(fitsio.read(samplefile, 'TRACTOR', columns=['type', 'shape_r']))
            if vi_sample == 901:
                I = ((fulltractor['type'] == 'PSF') * (fullsample['D26'] > 0.5) * (fullsample['GROUP_MULT'] == 1))
            elif vi_sample == 902:
                I = ((fulltractor['type'] == 'PSF') * (fullsample['D26'] > 0.5) * (fullsample['GROUP_MULT'] > 1))
        fullsample = fullsample[I]
        sample = fullsample[fullsample['GROUP_PRIMARY']]
    elif vi_sample > 950:
        sort_by_groupname = False
        #I = (((fullsample['ELLIPSEBIT'] & ELLIPSEBIT['NOTRACTOR']) != 0) *
        #     ((fullsample['ELLIPSEMODE'] & ELLIPSEMODE['FIXGEO']) == 0) *
        #     (fullsample['D26'] > 0.5))
        res = Table(fitsio.read(os.path.join(sga_dir(), 'sample', 'vi-v0.11', 'results-vi-v0.11.fits')))
        if vi_sample == 999:
            res = res[res['CLASS'] == 'Help!']
        elif vi_sample == 998:
            res = res[res['CLASS'] == 'Not a (large) galaxy']
        elif vi_sample == 997:
            res = res[res['CLASS'] == 'Bad geometry']
        elif vi_sample == 996:
            res = res[res['CLASS'] == 'Bad center']
        else:
            raise ValueError('Write me')
        I = np.isin(fullsample['OBJNAME'], res['OBJNAME'])
        fullsample = fullsample[I]
        sample = fullsample[fullsample['GROUP_PRIMARY']]
    else:
        qadir = os.path.join(sga_dir(), 'parent', 'qa')
        txtdir = os.path.join(sga_dir(), 'parent', 'txt')
        viewdir = os.path.join(sga_dir(), 'parent', 'viewer')

        if no_groups:
            pdfsuffix = '-no-groups'
        else:
            pdfsuffix = ''
        pdfbase = f'qa-tractor-{region}-sample{pdfsuffix}'

        #########################
        sort_by_groupname = False

        #I_overlap = ((fullsample['SAMPLE'] & SAMPLE['OVERLAP']) != 0) & (fullsample['GROUP_DIAMETER'] > 1.)
        #I_overlap = ((fullsample['SAMPLE'] & SAMPLE['OVERLAP']) != 0) & (fullsample['GROUP_DIAMETER'] > 1.) & (fullsample['GROUP_DIAMETER'] <= 1.5)
        I_overlap = ((fullsample['SAMPLE'] & SAMPLE['OVERLAP']) != 0) & (fullsample['GROUP_DIAMETER'] > 0.75) & (fullsample['GROUP_DIAMETER'] <= 1.)
        I_sdss = np.char.startswith(fullsample['OBJNAME'].astype(str), "SDSS")

        # Find groups satisfying each condition
        groups_with_overlap = set(fullsample['GROUP_NAME'][I_overlap])
        groups_with_sdss = set(fullsample['GROUP_NAME'][I_sdss])

        # Intersection = groups meeting BOTH conditions
        groups_target = groups_with_overlap & groups_with_sdss

        # Extract all rows from those groups
        rows = np.isin(fullsample['GROUP_NAME'], list(groups_target))
        I = rows & I_sdss

        #########################
        fullsample = fullsample[I]
        sample = fullsample

        # We still want to see and label nearby companions in
        # 'fullsample', i.e., without any diameter cuts.
        if no_groups:
            diamcolumn = 'DIAM'
            _, fullsample = read_sample(region=region)
        else:
            diamcolumn = DIAMCOLUMN
        fullsample = fullsample[np.isin(fullsample['GROUP_ID'], sample['GROUP_ID'])]
